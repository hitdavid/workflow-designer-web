<html lang="zh">
	<head>
		<meta charset="utf-8"/>
		<!-- saved from url=(0014)about:internet-->
		<title>审批流编辑器</title>
		
		<link rel="stylesheet" type="text/css" href="../scripts/easyui/themes/gray/easyui.css">
		<link rel="stylesheet" type="text/css" href="../scripts/easyui/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="styles/designer.css">
		
		<script src="../scripts/jquery/jquery-1.8.3.min.js"></script>
		<script src="../scripts/jquery/plugins/touchpunch/jquery-touch_punch.js"></script>
		<script src="../scripts/jquery/plugins/autoresize/jquery.autoresize.js"></script>		
		<script src="../scripts/jquery/plugins/contextmenu/jquery.contextmenu.js"></script>	
		<link rel="stylesheet" type="text/css" href="../scripts/jquery/plugins/contextmenu/jquery.contextmenu.css">
		
		<script src="../scripts/draw2d/lib/shifty.js"></script>
		<script src="../scripts/draw2d/lib/raphael.js"></script>
		<script src="../scripts/draw2d/lib/rgbcolor.js"></script>
		<script src="../scripts/draw2d/lib/canvg.js"></script>
		<script src="../scripts/draw2d/lib/Class.js"></script>
		<script src="../scripts/draw2d/lib/json2.js"></script>
		<script src="../scripts/draw2d/lib/pathfinding-browser.min.js"></script>
		
		
		<script src="../scripts/draw2d/draw2d.js"></script>		
		<script src="../scripts/easyui/jquery.easyui.min.js"></script>	
		
		<!-- 以下JS为应用的整体布局的JS -->
		<script src="Application.js"></script>	
		<script src="canvas/Canvas.js"></script>
		<script src="accordion/Accordion.js"></script>
		<script src="toolbar/ToolBar.js"></script>	
		
		<!-- 以下JS为各个节点的JS -->
		<script src="figures/Start.js"></script>	
		<script src="figures/End.js"></script>

		<!-- 固定人 -->
		<script src="figures/UserTask.js"></script>
        <!-- 自由流 -->
		<script src="figures/MailTask.js"></script>
		<!-- 角色 -->
		<script src="figures/RoleTask.js"></script>

		<script src="figures/ServiceTask.js"></script>
		<script src="figures/ScriptTask.js"></script>
		<script src="figures/ExclusiveGateway.js"></script>	
		<script src="figures/ParallelGateway.js"></script>
		<script src="figures/BranchTask.js"></script>

		<script>
			$(window).load(function(){
				//-- 2. activiti-designer的连接器(全局)
		
			
				var app = new com.chanjet.gzq.aflowApplication();

				var json = [
                    {
                        "type": "com.chanjet.gzq.aflowStart",
                        "id": "0c5fcb40-5f47-46a2-0cb5-dadea5685f43",
                        "x": 60,
                        "y": 218,
                        "width": 30,
                        "height": 30,
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "com_chanjet_gzq_aflowStart",
                        "ports": [
                            {
                                "name": "output0",
                                "port": "draw2d.OutputPort",
                                "locator": "draw2d.layout.locator.OutputPortLocator"
                            }
                        ],
                        "bgColor": "#FFFFFF",
                        "color": "#1B1B1B",
                        "stroke": 1
                    },
                    {
                        "type": "com.chanjet.gzq.aflowUserTask",
                        "id": "9a588d77-9af2-e1a4-5cd5-1df513d7b6a5",
                        "x": 310,
                        "y": 290,
                        "width": 201,
                        "height": 64,
                        "alpha": 1,
                        "userData": {
                            "name": "人工任务"
                        },
                        "cssClass": "com_chanjet_gzq_aflowUserTask",
                        "ports": [
                            {
                                "name": "input0",
                                "port": "draw2d.InputPort",
                                "locator": "draw2d.layout.locator.InputPortLocator"
                            },
                            {
                                "name": "output0",
                                "port": "draw2d.OutputPort",
                                "locator": "draw2d.layout.locator.OutputPortLocator"
                            }
                        ],
                        "bgColor": "#FFFFCC",
                        "color": "#1B1B1B",
                        "stroke": 1,
                        "radius": 5
                    },
                    {
                        "type": "com.chanjet.gzq.aflowEnd",
                        "id": "2593262b-6e1d-f4d9-77e8-b539b8b21aa4",
                        "x": 1015,
                        "y": 127,
                        "width": 28,
                        "height": 28.000000000000004,
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "com_chanjet_gzq_aflowEnd",
                        "ports": [
                            {
                                "name": "input0",
                                "port": "draw2d.InputPort",
                                "locator": "draw2d.layout.locator.InputPortLocator"
                            }
                        ],
                        "bgColor": "#FFFFFF",
                        "color": "#1B1B1B",
                        "stroke": 3
                    },
                    {
                        "type": "com.chanjet.gzq.aflowBranchTask",
                        "id": "f74b5eb8-0500-54af-cf17-bc6a7332aec1",
                        "x": 549,
                        "y": 81,
                        "width": 96,
                        "height": 64,
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "com_chanjet_gzq_aflowBranchTask",
                        "ports": [
                            {
                                "name": "input0",
                                "port": "draw2d.InputPort",
                                "locator": "draw2d.layout.locator.InputPortLocator"
                            },
                            {
                                "name": "output0",
                                "port": "draw2d.OutputPort",
                                "locator": "draw2d.layout.locator.OutputPortLocator"
                            },
                            {
                                "name": "output1",
                                "port": "draw2d.OutputPort",
                                "locator": "draw2d.layout.locator.OutputPortLocator"
                            }
                        ],
                        "bgColor": "#FFFFCC",
                        "color": "#1B1B1B",
                        "stroke": 1,
                        "radius": 10
                    },
                    {
                        "type": "com.chanjet.gzq.aflowUserTask",
                        "id": "43c5a9f0-3220-a03b-4813-5af6ad05e2f0",
                        "x": 843,
                        "y": 445,
                        "width": 96,
                        "height": 64,
                        "alpha": 1,
                        "userData": {
                            "name": "人工任务"
                        },
                        "cssClass": "com_chanjet_gzq_aflowUserTask",
                        "ports": [
                            {
                                "name": "input0",
                                "port": "draw2d.InputPort",
                                "locator": "draw2d.layout.locator.InputPortLocator"
                            },
                            {
                                "name": "output0",
                                "port": "draw2d.OutputPort",
                                "locator": "draw2d.layout.locator.OutputPortLocator"
                            }
                        ],
                        "bgColor": "#FFFFCC",
                        "color": "#1B1B1B",
                        "stroke": 1,
                        "radius": 5
                    },
                    {
                        "type": "com.chanjet.gzq.aflowUserTask",
                        "id": "84a3a32f-a6a4-c1fb-e38d-0924210d5a1a",
                        "x": 602,
                        "y": 615,
                        "width": 96,
                        "height": 64,
                        "alpha": 1,
                        "userData": {
                            "name": "人工任务"
                        },
                        "cssClass": "com_chanjet_gzq_aflowUserTask",
                        "ports": [
                            {
                                "name": "input0",
                                "port": "draw2d.InputPort",
                                "locator": "draw2d.layout.locator.InputPortLocator"
                            },
                            {
                                "name": "output0",
                                "port": "draw2d.OutputPort",
                                "locator": "draw2d.layout.locator.OutputPortLocator"
                            }
                        ],
                        "bgColor": "#FFFFCC",
                        "color": "#1B1B1B",
                        "stroke": 1,
                        "radius": 5
                    },
                    {
                        "type": "com.chanjet.gzq.aflowUserTask",
                        "id": "ee9fcb01-a544-d9eb-b936-8d097d3d2f67",
                        "x": 248,
                        "y": 103,
                        "width": 96,
                        "height": 64,
                        "alpha": 1,
                        "userData": {
                            "name": "人工任务"
                        },
                        "cssClass": "com_chanjet_gzq_aflowUserTask",
                        "ports": [
                            {
                                "name": "input0",
                                "port": "draw2d.InputPort",
                                "locator": "draw2d.layout.locator.InputPortLocator"
                            },
                            {
                                "name": "output0",
                                "port": "draw2d.OutputPort",
                                "locator": "draw2d.layout.locator.OutputPortLocator"
                            }
                        ],
                        "bgColor": "#FFFFCC",
                        "color": "#1B1B1B",
                        "stroke": 1,
                        "radius": 5
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "ba10c43e-74c1-140b-cd95-d1c4bf66335d",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "0c5fcb40-5f47-46a2-0cb5-dadea5685f43",
                            "port": "output0"
                        },
                        "target": {
                            "node": "9a588d77-9af2-e1a4-5cd5-1df513d7b6a5",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "ed7229dd-e6c0-79c1-c5c5-9bc7afe5a7e7",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "9a588d77-9af2-e1a4-5cd5-1df513d7b6a5",
                            "port": "output0"
                        },
                        "target": {
                            "node": "f74b5eb8-0500-54af-cf17-bc6a7332aec1",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "02eef014-ee51-743a-13a1-d74d4f5fe692",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "f74b5eb8-0500-54af-cf17-bc6a7332aec1",
                            "port": "output0"
                        },
                        "target": {
                            "node": "2593262b-6e1d-f4d9-77e8-b539b8b21aa4",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "62d5462b-8503-09c0-aa66-1c0ba026a931",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "f74b5eb8-0500-54af-cf17-bc6a7332aec1",
                            "port": "output1"
                        },
                        "target": {
                            "node": "43c5a9f0-3220-a03b-4813-5af6ad05e2f0",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "863e2efe-b6e1-944a-b681-9034de8c4080",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "43c5a9f0-3220-a03b-4813-5af6ad05e2f0",
                            "port": "output0"
                        },
                        "target": {
                            "node": "2593262b-6e1d-f4d9-77e8-b539b8b21aa4",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "f571ec80-af1b-9fcf-902a-bf541aa90737",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "9a588d77-9af2-e1a4-5cd5-1df513d7b6a5",
                            "port": "output0"
                        },
                        "target": {
                            "node": "84a3a32f-a6a4-c1fb-e38d-0924210d5a1a",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "3e7c6b27-7e64-b5ca-3937-821626b99cfd",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "84a3a32f-a6a4-c1fb-e38d-0924210d5a1a",
                            "port": "output0"
                        },
                        "target": {
                            "node": "43c5a9f0-3220-a03b-4813-5af6ad05e2f0",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "4c790c82-b89b-5bc7-67cd-ca744539e26a",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "9a588d77-9af2-e1a4-5cd5-1df513d7b6a5",
                            "port": "output0"
                        },
                        "target": {
                            "node": "43c5a9f0-3220-a03b-4813-5af6ad05e2f0",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "64b7f492-4135-5680-b562-85755ce97c70",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "9a588d77-9af2-e1a4-5cd5-1df513d7b6a5",
                            "port": "output0"
                        },
                        "target": {
                            "node": "ee9fcb01-a544-d9eb-b936-8d097d3d2f67",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "2b31c0a6-6f74-e2d4-369c-724516137f37",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "ee9fcb01-a544-d9eb-b936-8d097d3d2f67",
                            "port": "output0"
                        },
                        "target": {
                            "node": "43c5a9f0-3220-a03b-4813-5af6ad05e2f0",
                            "port": "input0"
                        }
                    },
                    {
                        "type": "draw2d.Connection",
                        "id": "88fbdc33-a273-3195-00af-4bf830aadd0f",
                        "alpha": 1,
                        "userData": {},
                        "cssClass": "draw2d_Connection",
                        "stroke": 1,
                        "color": "#1B1B1B",
                        "outlineStroke": 0,
                        "outlineColor": "none",
                        "policy": "draw2d.policy.line.LineSelectionFeedbackPolicy",
                        "router": "draw2d.layout.connection.SplineConnectionRouter",
                        "radius": 2,
                        "source": {
                            "node": "ee9fcb01-a544-d9eb-b936-8d097d3d2f67",
                            "port": "output0"
                        },
                        "target": {
                            "node": "f74b5eb8-0500-54af-cf17-bc6a7332aec1",
                            "port": "input0"
                        }
                    }
                ];
			
				
				app.loadFigure(json);
				
				/*
				updatePreview(app.canvas);
				
				app.canvas.getCommandStack().addEventListener(function(e){
				  if(e.isPostChangeEvent()){
					  updatePreview(app.canvas);
				   }
				});
				*/
				
				displayJSON(app.canvas);
				// JSON2Canvas(app.canvas);
				// PNG(app.canvas);
				
				app.canvas.getCommandStack().addEventListener(function(e){
				  if(e.isPostChangeEvent()){
					  displayJSON(app.canvas);
				   }
				}); 
				
			});
			

			function updatePreview(canvas){
			
				//-- convert the canvas into a PNG IMage source string
				var xCoords = [];
				var yCoords = [];
				canvas.getFigures().each(function(i,f){
					var b = f.getBoundingBox();
					xCoords.push(b.x,b.x+b.w);
					yCoords.push(b.y,b.y+b.h);
				});
				
				var minX = Math.min.apply(Math,xCoords);
				var minY = Math.min.apply(Math,yCoords);
				var width = Math.max.apply(Math,xCoords)-minX;
				var height = Math.max.apply(Math,yCoords)-minY;
			
				var writer = new draw2d.io.png.Writer();
				writer.marshal(canvas,function(png){
				   $("#preview").attr("src",png);
				},new draw2d.geo.Rectangle(minX,minY,width,height));
			};
			
			function displayJSON(canvas){
				//-- test code
				/*
				canvas.getFigures().each(function(i,f){
					console.log(f.NAME);		//-- Node Type
					console.log(f.getId());		//-- Node ID
					console.log(f.toXML());		//-- Node Mapped XML
				});
				*/
				//-- test code
				
				var writer = new draw2d.io.json.Writer();
				writer.marshal(canvas, function(json){
					$("#json").text(JSON.stringify(json, null, 2));
				});
			}
			
		</script>	
		
	</head>
	<body id="bpm-layout" class="easyui-layout">
		<div data-options="region:'north',height:36,border:false">
			<div id="activitiToolBar" class="easyui-panel" border="0" style="padding:5px;background:#E1F0F2">
				<a href="javascript:void(0)" class="easyui-splitbutton" menu="#edit-menu" iconCls="icon-edit">Edit</a>
				<div id="edit-menu" style="width:300px;">
					<div id="undoButton" iconCls="icon-undo" onclick="javascript:void(0)">Undo</div>
					<div id="redoButton" iconCls="icon-redo" onclick="javascript:void(0)">Redo</div>
				</div>
			</div>
		</div>
		<div data-options="region:'west',width:150" iconCls="bpm-nav-icon" title="工具箱">
			<div class="easyui-accordion" fit="true" border="1">
				<div id="event" title="起止" iconCls="bpm-menu-icon" class="bpm-menu">
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="start-event-icon" nodeType="Start">开始</a><br>
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="end-event-icon" nodeType="End">结束</a><br>
				</div>
				<div id="task" title="节点" iconCls="bpm-menu-icon" selected="true" class="bpm-menu">
					<a href="#" class="easyui-linkbutton" plain="true" iconCls="user-task-icon" nodeType="UserTask">固定人员</a><br>
					<a href="#" class="easyui-linkbutton" plain="true" iconCls="manual-task-icon" nodeType="RoleTask">上级主管</a><br>
					<a href="#" class="easyui-linkbutton" plain="true" iconCls="service-task-icon" nodeType="ServiceTask">自由选择</a><br>
				</div>
				<div id="gateway" title="会签" iconCls="bpm-menu-icon" class="bpm-menu">
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="parallel-gateway-icon" nodeType="ParallelGateway">必选会签</a><br>
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="exclusive-gateway-icon" nodeType="ExclusiveGateway">可选会签</a><br>
				</div>
				<div id="boundary-event" title="条件" iconCls="bpm-menu-icon" class="bpm-menu">
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="branch-task-icon" nodeType="BranchTask">分支条件</a><br>
				</div>
				<div id="notify" title="通知" iconCls="bpm-menu-icon" class="bpm-menu">
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="branch-task-icon" nodeType="BranchTask">邮件通知</a><br>
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="branch-task-icon" nodeType="BranchTask">消息通知</a><br>
				</div>
			</div>
		</div>
		<div data-options="region:'center'" title="工作区">
			<div id="activitiCanvas" style="position:relative;width:2500px;height:2500px;background-image:url(styles/images/grid.png);"></div>

			<!-- 暂时注释掉预览图的功能
			<div style="border-radius:5px;overflow:auto;position:absolute; top:30px; right:20px; width:350px; height:250px; border:3px solid gray;background-color:#dceffd;opacity:0.8">
				<img id="preview" style="width:350px; height:250px;"/>
			</div>
			-->

			<pre id="json" style="border-radius:5px;overflow:auto;position:absolute; top:30px; right:20px; width:350px; height:500px; border:3px solid gray;background-color:#dceffd;opacity:0.8">
			</pre>

		</div>
		<div data-options="region:'east',width:300,collapsed:true" title="属性"></div>
	</body>
</html>