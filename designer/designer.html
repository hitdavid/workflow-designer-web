<html lang="zh">
	<head>
		<meta charset="utf-8"/>
		<!-- saved from url=(0014)about:internet-->
		<title>审批流编辑器</title>
		
		<link rel="stylesheet" type="text/css" href="../scripts/easyui/themes/gray/easyui.css">
		<link rel="stylesheet" type="text/css" href="../scripts/easyui/themes/icon.css">
		<link rel="stylesheet" type="text/css" href="styles/designer.css">
		
		<script src="../scripts/jquery/jquery-1.8.3.min.js"></script>
		<script src="../scripts/jquery/plugins/touchpunch/jquery-touch_punch.js"></script>
		<script src="../scripts/jquery/plugins/autoresize/jquery.autoresize.js"></script>		
		<script src="../scripts/jquery/plugins/contextmenu/jquery.contextmenu.js"></script>	
		<link rel="stylesheet" type="text/css" href="../scripts/jquery/plugins/contextmenu/jquery.contextmenu.css">
		
		<script src="../scripts/draw2d/lib/shifty.js"></script>
		<script src="../scripts/draw2d/lib/raphael.js"></script>
		<script src="../scripts/draw2d/lib/rgbcolor.js"></script>
		<script src="../scripts/draw2d/lib/canvg.js"></script>
		<script src="../scripts/draw2d/lib/Class.js"></script>
		<script src="../scripts/draw2d/lib/json2.js"></script>
		<script src="../scripts/draw2d/lib/pathfinding-browser.min.js"></script>
		
		
		<script src="../scripts/draw2d/draw2d.js"></script>		
		<script src="../scripts/easyui/jquery.easyui.min.js"></script>	
		
		<!-- 以下JS为应用的整体布局的JS -->
		<script src="Application.js"></script>	
		<script src="canvas/Canvas.js"></script>
		<script src="accordion/Accordion.js"></script>
		<script src="toolbar/ToolBar.js"></script>	
		
		<!-- 以下JS为各个节点的JS -->
		<script src="figures/Start.js"></script>	
		<script src="figures/End.js"></script>

		<!-- 固定人 -->
		<script src="figures/UserTask.js"></script>
        <!-- 自由流 -->
		<script src="figures/MailTask.js"></script>
		<!-- 角色 -->
		<script src="figures/RoleTask.js"></script>

		<script src="figures/ServiceTask.js"></script>
		<script src="figures/ScriptTask.js"></script>
		<script src="figures/ExclusiveGateway.js"></script>	
		<script src="figures/ParallelGateway.js"></script>
		<script src="figures/BranchTask.js"></script>

		<script>

            var json = [];

            var app

			$(window).load(function(){
				//-- 2. activiti-designer的连接器(全局)

				app = new com.chanjet.gzq.aflowApplication();

                $.getJSON("http://localhost:8888/", function(result){
                    app.loadFigure(result);
                });

				//app.loadFigure(json);
				
				/*
				updatePreview(app.canvas);
				
				app.canvas.getCommandStack().addEventListener(function(e){
				  if(e.isPostChangeEvent()){
					  updatePreview(app.canvas);
				   }
				});
				*/
				
				displayJSON(app.canvas);
				// JSON2Canvas(app.canvas);
				// PNG(app.canvas);
				
				app.canvas.getCommandStack().addEventListener(function(e){
				  if(e.isPostChangeEvent()){
					  displayJSON(app.canvas);
				   }
				}); 
				
			});

            $('#jsonInput').on('change input paste', function() {
                var value = $(this).val();

                if(value.length){
                    app.loadFigure(value);
                }
            });


			function updatePreview(canvas){
			
				//-- convert the canvas into a PNG IMage source string
				var xCoords = [];
				var yCoords = [];
				canvas.getFigures().each(function(i,f){
					var b = f.getBoundingBox();
					xCoords.push(b.x,b.x+b.w);
					yCoords.push(b.y,b.y+b.h);
				});
				
				var minX = Math.min.apply(Math,xCoords);
				var minY = Math.min.apply(Math,yCoords);
				var width = Math.max.apply(Math,xCoords)-minX;
				var height = Math.max.apply(Math,yCoords)-minY;
			
				var writer = new draw2d.io.png.Writer();
				writer.marshal(canvas,function(png){
				   $("#preview").attr("src",png);
				},new draw2d.geo.Rectangle(minX,minY,width,height));
			};
			
			function displayJSON(canvas){
				//-- test code
				/*
				canvas.getFigures().each(function(i,f){
					console.log(f.NAME);		//-- Node Type
					console.log(f.getId());		//-- Node ID
					console.log(f.toXML());		//-- Node Mapped XML
				});
				*/
				//-- test code
				
				var writer = new draw2d.io.json.Writer();
				writer.marshal(canvas, function(json){
					$("#jsonOutput").text(JSON.stringify(json, null, 2));
				});
			}

			
		</script>	
		
	</head>
	<body id="bpm-layout" class="easyui-layout">
		<div data-options="region:'north',height:36,border:false">
			<div id="activitiToolBar" class="easyui-panel" border="0" style="padding:5px;background:#E1F0F2">
				<a href="javascript:void(0)" class="easyui-splitbutton" menu="#edit-menu" iconCls="icon-edit">Edit</a>
				<div id="edit-menu" style="width:300px;">
					<div id="undoButton" iconCls="icon-undo" onclick="javascript:void(0)">Undo</div>
					<div id="redoButton" iconCls="icon-redo" onclick="javascript:void(0)">Redo</div>
				</div>
			</div>
		</div>
		<div data-options="region:'west',width:150" iconCls="bpm-nav-icon" title="工具箱">
			<div class="easyui-accordion" fit="true" border="1">
				<div id="event" title="起止" iconCls="bpm-menu-icon" class="bpm-menu">
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="start-event-icon" nodeType="Start">开始</a><br>
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="end-event-icon" nodeType="End">结束</a><br>
				</div>
				<div id="task" title="节点" iconCls="bpm-menu-icon" selected="true" class="bpm-menu">
					<a href="#" class="easyui-linkbutton" plain="true" iconCls="user-task-icon" nodeType="UserTask">固定人员</a><br>
					<a href="#" class="easyui-linkbutton" plain="true" iconCls="manual-task-icon" nodeType="RoleTask">上级主管</a><br>
					<a href="#" class="easyui-linkbutton" plain="true" iconCls="service-task-icon" nodeType="ServiceTask">自由选择</a><br>
				</div>
				<div id="gateway" title="会签" iconCls="bpm-menu-icon" class="bpm-menu">
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="parallel-gateway-icon" nodeType="ParallelGateway">必选会签</a><br>
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="exclusive-gateway-icon" nodeType="ExclusiveGateway">可选会签</a><br>
				</div>
				<div id="boundary-event" title="条件" iconCls="bpm-menu-icon" class="bpm-menu">
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="branch-task-icon" nodeType="BranchTask">分支条件</a><br>
				</div>
				<div id="notify" title="通知" iconCls="bpm-menu-icon" class="bpm-menu">
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="branch-task-icon" nodeType="BranchTask">邮件通知</a><br>
					<a href="##" class="easyui-linkbutton" plain="true" iconCls="branch-task-icon" nodeType="BranchTask">消息通知</a><br>
				</div>
			</div>
		</div>
		<div data-options="region:'center'" title="工作区">
			<div id="activitiCanvas" style="position:relative;width:2500px;height:2500px;background-image:url(styles/images/grid.png);"></div>

			<!-- 暂时注释掉预览图的功能
			<div style="border-radius:5px;overflow:auto;position:absolute; top:30px; right:20px; width:350px; height:250px; border:3px solid gray;background-color:#dceffd;opacity:0.8">
				<img id="preview" style="width:350px; height:250px;"/>
			</div>
			-->

			<pre id="jsonOutput" style="border-radius:5px;
								overflow:auto;
								position:absolute;
								top:30px;
								right:20px;
								width:350px;
								height:300px;
								border:3px solid gray;
								background-color:#dceffd;
								opacity:0.8">
			</pre>

		</div>
		<div data-options="region:'east',width:300,collapsed:true" title="属性"></div>
	</body>
</html>